---
name: PR Review by OpenHands

on:
    # Use pull_request_target to allow fork PRs to access secrets when triggered by maintainers
    # Security: This workflow runs when:
    #   1. A new PR is opened (non-draft), OR
    #   2. A draft PR is marked as ready for review, OR
    #   3. A maintainer adds the 'review-this' label, OR
    #   4. A maintainer requests openhands-agent or all-hands-bot as a reviewer
    # Adding labels and requesting reviewers requires write access.
    # The PR code is explicitly checked out for review, but secrets are only accessible
    # because the workflow runs in the base repository context.
    pull_request_target:
        types: [opened, ready_for_review, labeled, review_requested]

permissions:
    contents: read
    pull-requests: write
    issues: write

jobs:
    pr-review:
        # Automatic reviews only run for collaborators (author association: COLLABORATOR/MEMBER/OWNER).
        #
        # Manual triggers (label/reviewer request) still work for any PR, but are permission-gated:
        # we only proceed if the *triggering user* has write (or higher) permission.
        #
        # "Triggering user" here means `github.actor` / `context.actor`: the account that caused
        # this workflow run (e.g. the user who added the label or requested the reviewer).
        if: |
            (github.event.action == 'opened' &&
              github.event.pull_request.draft == false &&
              contains(fromJSON('["COLLABORATOR","MEMBER","OWNER"]'), github.event.pull_request.author_association)) ||
            (github.event.action == 'ready_for_review' &&
              contains(fromJSON('["COLLABORATOR","MEMBER","OWNER"]'), github.event.pull_request.author_association)) ||
            (github.event.action == 'labeled' && github.event.label.name == 'review-this') ||
            (github.event.action == 'review_requested' &&
              (github.event.requested_reviewer.login == 'openhands-agent' || github.event.requested_reviewer.login == 'all-hands-bot'))
        concurrency:
            group: pr-review-${{ github.event.pull_request.number }}
            cancel-in-progress: true
        runs-on: ubuntu-24.04
        steps:
            - name: Verify triggering user permission (write or higher)
              id: trigger-permission
              if: github.event.action == 'labeled' || github.event.action == 'review_requested'
              uses: actions/github-script@v7
              with:
                  github-token: ${{ github.token }}
                  script: |
                      const allowed = new Set(["admin", "maintain", "write"]);
                      const username = context.actor;
                      let permission = "none";

                      try {
                        const { data } = await github.rest.repos.getCollaboratorPermissionLevel({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          username,
                        });
                        permission = data.permission;
                      } catch (e) {
                        // Non-collaborators return 404
                        if (e.status !== 404) throw e;
                      }

                      core.setOutput("permission", permission);
                      core.setOutput("allowed", allowed.has(permission) ? "true" : "false");

            - name: Run PR Review
              # Automatic trusted PRs (opened/ready_for_review by collaborators)
              # OR manual triggers (label/review_requested) when the triggering user has write+ permission.
              if: github.event.action == 'opened' || github.event.action == 'ready_for_review' || steps.trigger-permission.outputs.allowed == 'true'
              uses: OpenHands/extensions/plugins/pr-review@main
              with:
                  llm-model: litellm_proxy/claude-sonnet-4-5-20250929
                  llm-base-url: https://llm-proxy.app.all-hands.dev
                  # Review style: roasted (other option: standard)
                  review-style: roasted
                  llm-api-key: ${{ secrets.LLM_API_KEY }}
                  github-token: ${{ secrets.ALLHANDS_BOT_GITHUB_PAT }}
                  lmnr-api-key: ${{ secrets.LMNR_SKILLS_API_KEY }}
